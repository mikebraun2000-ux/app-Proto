<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend Debug Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .debug-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .error { color: #dc3545; }
        .success { color: #198754; }
        .warning { color: #ffc107; }
        .info { color: #0d6efd; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h2>üîç Frontend Debug Tool</h2>
                <p>Testet Frontend-Funktionen und identifiziert Speicher-Probleme</p>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üß™ Tests</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary mb-2 w-100" onclick="testLogin()">1. Login testen</button>
                        <button class="btn btn-success mb-2 w-100" onclick="testEventListeners()">2. Event Listener pr√ºfen</button>
                        <button class="btn btn-warning mb-2 w-100" onclick="testFormSubmission()">3. Form Submit testen</button>
                        <button class="btn btn-info mb-2 w-100" onclick="testProjectSave()">4. Projekt speichern testen</button>
                        <button class="btn btn-secondary mb-2 w-100" onclick="testMainApp()">5. Haupt-App Status</button>
                        <button class="btn btn-danger w-100" onclick="clearLog()">Log l√∂schen</button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üìù Test Formular</h5>
                    </div>
                    <div class="card-body">
                        <form id="debugTestForm">
                            <div class="mb-3">
                                <label class="form-label">Projektname</label>
                                <input type="text" class="form-control" id="debugProjectName" name="projectName" value="Debug Test Projekt">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Beschreibung</label>
                                <textarea class="form-control" id="debugProjectDescription" name="projectDescription">Test aus Debug Tool</textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Kunde</label>
                                <input type="text" class="form-control" id="debugProjectClient" name="projectClient" value="Debug Kunde">
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Formular testen</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üìä Debug Log</h5>
                    </div>
                    <div class="card-body">
                        <div id="debugLog" class="debug-log">
                            <div class="info">Frontend Debug Tool geladen. Warten auf Tests...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Debug Variablen
        let authToken = null;
        const API_BASE = '';

        // Logging Funktionen
        function log(message, type = 'info') {
            const debugLog = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            debugLog.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('debugLog').innerHTML = '<div class="info">Log gel√∂scht. Bereit f√ºr neue Tests...</div>';
        }

        // Test 1: Login
        async function testLogin() {
            log('üîê Teste Login...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    })
                });

                log(`Login Response Status: ${response.status}`, response.ok ? 'success' : 'error');

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    localStorage.setItem('access_token', authToken);
                    log('‚úì Token erhalten und gespeichert', 'success');
                    log(`Token (erste 20 Zeichen): ${authToken.substring(0, 20)}...`, 'info');
                } else {
                    const errorText = await response.text();
                    log(`Login Fehler: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`Login Exception: ${error.message}`, 'error');
            }
        }

        // Test 2: Event Listeners
        function testEventListeners() {
            log('üéØ Teste Event Listeners...', 'info');

            // Pr√ºfe ob Haupt-App JavaScript geladen wurde
            if (typeof handleProjectSubmit === 'function') {
                log('‚úì handleProjectSubmit Funktion gefunden', 'success');
            } else {
                log('‚úó handleProjectSubmit Funktion NICHT gefunden!', 'error');
            }

            if (typeof setupFormEventListeners === 'function') {
                log('‚úì setupFormEventListeners Funktion gefunden', 'success');
            } else {
                log('‚úó setupFormEventListeners Funktion NICHT gefunden!', 'error');
            }

            // Pr√ºfe Event Listener auf Test-Formular
            const testForm = document.getElementById('debugTestForm');
            if (testForm) {
                const listeners = getEventListeners ? getEventListeners(testForm) : 'Chrome DevTools erforderlich';
                log(`Test-Formular Event Listeners: ${JSON.stringify(listeners)}`, 'info');
            }
        }

        // Test 3: Form Submission
        function testFormSubmission() {
            log('üìù Teste Form Submission...', 'info');

            const form = document.getElementById('debugTestForm');
            const formData = new FormData(form);

            log('FormData Inhalt:', 'info');
            for (let [key, value] of formData.entries()) {
                log(`  ${key}: ${value}`, 'info');
            }

            // Teste Datenextraktion
            const extractedData = {
                name: formData.get('projectName'),
                description: formData.get('projectDescription'),
                client_name: formData.get('projectClient')
            };

            log(`Extrahierte Daten: ${JSON.stringify(extractedData, null, 2)}`, 'info');

            if (extractedData.name && extractedData.description) {
                log('‚úì FormData korrekt extrahiert', 'success');
            } else {
                log('‚úó FormData Extraktion fehlerhaft!', 'error');
            }
        }

        // Test 4: Projekt speichern
        async function testProjectSave() {
            log('üíæ Teste Projekt speichern...', 'info');

            // Token pr√ºfen
            if (!authToken) {
                authToken = localStorage.getItem('access_token');
                if (!authToken) {
                    log('‚úó Kein Token verf√ºgbar - f√ºhre Login zuerst aus!', 'error');
                    return;
                }
            }

            const projectData = {
                name: 'Frontend Debug Projekt',
                description: 'Test aus Frontend Debug Tool',
                client_name: 'Debug Tool Kunde',
                project_type: 'trockenbau',
                status: 'aktiv'
            };

            log(`Sende Projekt-Daten: ${JSON.stringify(projectData, null, 2)}`, 'info');

            try {
                const response = await fetch(`${API_BASE}/projects`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(projectData)
                });

                log(`Projekt Response Status: ${response.status}`, response.ok ? 'success' : 'error');
                
                const responseText = await response.text();
                log(`Response Body: ${responseText}`, response.ok ? 'success' : 'error');

                if (response.ok) {
                    const result = JSON.parse(responseText);
                    log(`‚úì Projekt erfolgreich gespeichert! ID: ${result.id}`, 'success');
                } else {
                    log(`‚úó Projekt speichern fehlgeschlagen!`, 'error');
                }
            } catch (error) {
                log(`Projekt Save Exception: ${error.message}`, 'error');
            }
        }

        // Test 5: Haupt-App Status
        function testMainApp() {
            log('üè† Teste Haupt-App Status...', 'info');

            // Pr√ºfe ob Haupt-App Elemente existieren
            const mainAppElements = [
                'projectForm',
                'projectModal',
                'projectName',
                'projectDescription'
            ];

            let foundElements = 0;
            mainAppElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    log(`‚úì Element '${elementId}' gefunden`, 'success');
                    foundElements++;
                } else {
                    log(`‚úó Element '${elementId}' NICHT gefunden!`, 'error');
                }
            });

            log(`Haupt-App Elemente: ${foundElements}/${mainAppElements.length} gefunden`, 
                foundElements === mainAppElements.length ? 'success' : 'warning');

            // Pr√ºfe localStorage
            const savedToken = localStorage.getItem('access_token');
            if (savedToken) {
                log(`‚úì Token in localStorage vorhanden (${savedToken.substring(0, 20)}...)`, 'success');
            } else {
                log('‚úó Kein Token in localStorage!', 'error');
            }

            // Pr√ºfe currentUser Variable
            if (typeof currentUser !== 'undefined' && currentUser) {
                log(`‚úì currentUser Variable: ${JSON.stringify(currentUser)}`, 'success');
            } else {
                log('‚úó currentUser Variable nicht verf√ºgbar!', 'error');
            }
        }

        // Form Submit Handler f√ºr Test-Formular
        document.getElementById('debugTestForm').addEventListener('submit', function(event) {
            event.preventDefault();
            log('üìã Test-Formular Submit Event ausgel√∂st', 'info');
            testFormSubmission();
        });

        // Initial Setup
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Frontend Debug Tool initialisiert', 'success');
            
            // Pr√ºfe ob Token bereits vorhanden
            const existingToken = localStorage.getItem('access_token');
            if (existingToken) {
                authToken = existingToken;
                log('üîë Vorhandenes Token gefunden', 'info');
            }

            // Pr√ºfe ob Haupt-App JavaScript verf√ºgbar ist
            setTimeout(() => {
                if (typeof handleProjectSubmit === 'function') {
                    log('‚úì Haupt-App JavaScript ist verf√ºgbar', 'success');
                } else {
                    log('‚ö†Ô∏è Haupt-App JavaScript m√∂glicherweise nicht geladen', 'warning');
                }
            }, 1000);
        });
    </script>
</body>
</html>
